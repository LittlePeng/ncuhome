<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>

    <script src="../Inc/Js/base.js" type="text/javascript"></script>
        <script src="../Inc/Js/jquery-1.2.3-intellisense.js" type="text/javascript"></script>
<!--    <script src="../Inc/Js/Template.js" type="text/javascript"></script>-->
<!--    <script src="../Inc/Js/json.js" type="text/javascript"></script>
-->  
  
</head>
<body>
<div id="div1"></div>
<hr />
<div id="UserList"></div>
<hr />
<div id="GuestList"></div>
 <hr />
   <div id="PublicChatResults"></div>
<hr />
   <div id="PrivateChatResults"></div>
</body>
  <script type="text/javascript">
      var cnum = watcher = currentPrivateId = currentPublicId = -1;
      var userName;

      function Prepare() {
          cnum = 67;
          //cnum = document.getElementById("chatNumber").value;
          //userName = sender = document.getElementById("sender").value;
          userName = "刘李进3";
          Check();
      }
      function Check() {
          $.ajax({
              url: "/newChatService.asmx/GetNewChatInfo",
              cache: false,
              type: "POST",
              data: makePa(),
              contentType: "application/json;utf-8",
              success: function(data) {
                  try {
                      op(data);
                  }
                  catch (e) {
                      return;
                  }
              },
              error: function(err) {
                  alert(err);
              }
          });
          setTimeout("Check()", 4000);
      }
      function makePa() {
          var ret = "";
          if (watcher >= 4 || watcher < 0) {
              ret = "{ChatNum:" + cnum + ",UserName:\"" + userName + "\",IsUserState:true, IsOnlineUserCount:true,IsGuestUserName:true, IsUserUserName:true,IsPublicChatList:true,IsPrivateChatList:true, CurrentChatId:" + currentPublicId + ",CurrentPrivateId:" + currentPrivateId + "}";
              watcher = 1;
          }
          else {
              ret = "{ChatNum:" + cnum + ",UserName:\"" + userName + "\",IsUserState:false, IsOnlineUserCount:false,IsGuestUserName:false, IsUserUserName:false,IsPublicChatList:true,IsPrivateChatList:true, CurrentChatId:" + currentPublicId + ",CurrentPrivateId:" + currentPrivateId + "}";
              watcher++;
          }
          return ret;
      }
      function op(data) {
          //var myObject = JSON.parse(data, null);           
          var myObject = eval('(' + data + ')');

          if (myObject.d.IsChange) { /*nothing*/ }

          doUserStatus(myObject.d.UserState);
          doUserList(myObject.d.GuestUser, myObject.d.UserUser);
          doChatList(myObject.d.PublicChatList, myObject.d.PrivateChatList);
      }

      function doUserStatus(status) {
          if (status == "0")
              return;
          if (status == "2") {
              chatClose(); return;
          }
          kickUser(status);
      }

      function chatClose() { alert('clost'); }
      function kickUser(reason) { alert('kick'); }

      var oldUserList;
      function doUserList(guest, user) {
          var temparr = new Array();
          var users = "";
          var oldFlag = new Array();
          var newFlag = new Array();

          if (oldUserList != null && oldUserList.length > 0) {
              if (oldUserList != null && oldUserList.length > 0) {
                  for (var i = 0; i < oldUserList.length; i++) {
                      oldFlag.push(0);
                  }
              }

              if (user != null && user.length > 0) {
                  for (var i = 0; i < user.length; i++) {
                      newFlag.push(2);
                  }
              }

              for (var i = 0; i < user.length; i++) {
                  find(oldUserList, user[i].UserId, newFlag, i, oldFlag);
              }

              var str = "";
              for (var i = 0; i < oldFlag.length; i++) {
                  //remove all the users who is offline
                  if (oldFlag[i] == 0) {
                      var elemToDelete = document.getElementById("User_" + oldUserList[i].UserId);
                      document.getElementById("UserList").removeChild(elemToDelete);
                      
                      elemToDelete = document.getElementById("UserBr_" + oldUserList[i].UserId);
                      document.getElementById("UserList").removeChild(elemToDelete);
                  }
              }

              for (var i = 0; i < newFlag.length; i++) {
                  //append the users who is new
                  if (newFlag[i] == 2) {
                      var elemToAppend = document.createElement("A");
                      elemToAppend.innerHTML = user[i].Name;
                      elemToAppend.id = "User_" + user[i].UserId;
                      elemToAppend.href = "javascript:ChangeTalkTo('" + user[i].Name + "')";
                      document.getElementById("UserList").appendChild(elemToAppend);

                      elemToAppend = document.createElement("BR");
                      elemToAppend.id = "UserBr_" + user[i].UserId;
                      document.getElementById("UserList").appendChild(elemToAppend);
                  }
              }
              oldUserList = user;
          }
          else {//输出页面
              oldUserList = user;
              var sb = new StringBuilder();
              if (user.length > 0) {
                  for (var i = 0; i < user.length; i++) {
                      sb.append("<a id=User_");
                      sb.append(user[i].UserId);
                      sb.append(" href=\"javascript:ChangeTalkTo('");
                      sb.append(user[i].Name);
                      sb.append("')\">");
                      sb.append(user[i].Name);
                      sb.append("</a> <br />");
                  }
                  replaceHtml("UserList", sb.toString());
              }
          }
      }
      
      function find(arr, val, newFlag, index, oldFlag) {
          var start = 0;
          var end = arr.length - 1;
          var mid = parseInt(arr.length / 2);

          if (val < arr[start].UserId || val > arr[end].UserId) {
              return false;
          }
          
          if (val == arr[start].UserId ) {
              if (newFlag != null && newFlag.length > 0) {
                  newFlag[index] = 1;
                  oldFlag[start] = 1;
              }
              return true;
          }
          
          if (val == arr[end].UserId ){
              if (newFlag != null && newFlag.length > 0) {
                  newFlag[index] = 1;
                  oldFlag[end] = 1;
              }
              return true;
          }
          
          while (start < mid && mid < end) {

              if (val > arr[mid].UserId) {
                  start = mid;
                  mid = parseInt((mid + end) / 2);
              }
              else if (val < arr[mid].UserId) {
                  end = mid;
                  mid = parseInt((mid + start) / 2);
              }
              else {
                  if (newFlag != null && newFlag.length > 0) {
                      newFlag[index] = 1;
                      oldFlag[mid] = 1;
                  }
                  return true;
              }
          }
          return false;
      }
      
      function doChatList(pub, pri) {

          var content = "";
          for (var i = 0; i < pub.length; i++) {
              if (i == 0)
                  currentPublicId = pub[i].Chat_Id;

              content = content + "<table><tr><td style=\"font-size:14\"><a style=\"color:#AA00CC\" href=\"javascript:ChangeTalkTo('" + pub[i].Sender + "\">" + pub[i].Sender + "</a>对<a style=\"color:#AA00CC\" href=\"javascript:ChangeTalkTo('" + pub[i].Sendto + ")')\">" + pub[i].Sendto + "</a>说：<font style=\"line-height: 180%; color:#333333\">" + pub[i].Content + "</font>&nbsp;&nbsp;<font style=\"color:#999999\">(" + pub[i].CreateTime + ")</font></td></tr></table>"

          }
          //document.getElementById("PublicChatResults").innerHTML = document.getElementById("PublicChatResults").innerHTML + content;

          content = "";
          for (var i = 0; i < pri.length; i++) {
              if (i == 0)
                  currentPrivateId = pri[i].Chat_Id;
              content = content + "<table><tr><td style=\"font-size:14\"><a style=\"color:#AA00CC\" href=\"javascript:ChangeTalkTo('" + pri[i].Sender + "\">" + pri[i].Sender + "</a>对<a style=\"color:#AA00CC\" href=\"javascript:ChangeTalkTo('" + pri[i].Sendto + ")')\">" + pri[i].Sendto + "</a>说：<font style=\"line-height: 180%; color:#333333\">" + pri[i].Content + "</font>&nbsp;&nbsp;<font style=\"color:#999999\">(" + pri[i].CreateTime + ")</font></td></tr></table>"
            }

            //document.getElementById("PrivateChatResults").innerHTML = document.getElementById("PrivateChatResults").innerHTML + content;
        }
        Prepare();
    </script>
</html>
